---
title: "Carbon Intensity API"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

### Imports

```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(lubridate)
```

### Current Carbon Intensity 

The first request will get the carbon intensity for current half-hour period:  

```{r}
# Make the request
r <- GET('https://api.carbonintensity.org.uk/intensity')
```

The response body is in JSON format, which we can visualise with `prettify()`

```{r}
prettify(content(r, 'text'))
```

To parse the results and convert it to a data frame, we first need to convert the JSON data to an R object. The `fromJSON()` function can be used to convert from JSON to a number of objects automatically. In this case, it will convert the response to a list.

```{r}
# Parse the results from JSON 
parsed <- fromJSON(content(r, 'text'))

class(parsed)
```

There is only one element in this list, `data`, which is a *nested* data frame: the `intensity` column is itself a data frame with three columns: `forecast`, `actual` and `index`. 

```{r}
print(names(parsed$data))
print(names(parsed$data$intensity))
```

We can use `unnest()` to flatten this to a single, unnest data frame wiht 5 columns.

```{r}
# Unnest the intensity data 
df <- parsed$data %>% unnest(cols = intensity)
df
```

Now we will wrap this in a function: 

```{r}
get_carbon_intensity <- function(){
  r <- GET('https://api.carbonintensity.org.uk/intensity')
  parsed <- fromJSON(content(r, 'text'))
  df <- parsed$data %>% unnest(cols = intensity)
  return(df)
}

get_carbon_intensity()
```


### Next 24h Carbon Intensity

The following code retrieves the forecast carbon intensity for the next 24 hours:

```{r}
# Current date time
dt_now <- now() %>% format('%Y-%m-%dT%H:%MZ') # ISO8601 format

# Use sprintf to format the URL 
url <- sprintf('https://api.carbonintensity.org.uk/intensity/%s/fw24h', dt_now)

# Make the request
r <- GET(url)

# Parse results
parsed <- fromJSON(content(r, 'text'))
df <- parsed$data %>% unnest(cols = intensity)

head(df)
```

### Regional Carbon Intensity

The code below retrieves current regional carbon intensities and prints the regions which have the lowest and highest intensities. 

```{r}
# Make the requeast
r <- GET('https://api.carbonintensity.org.uk/regional')

# Parse the JSON response
parsed <- fromJSON(content(r, 'text'))

# parsed$data$regions is a list of length 1
# The following line retrieves this element, which is a nested data frame
regions <- parsed$data$regions[[1]]

# Unnest the intensity data
regions_intensity <- regions %>% unnest(cols = intensity)

# Retrieve the regions with lowest and highest CO2 intensity
min_region <- regions_intensity$shortname[which.min(regions_intensity$forecast)]
max_region <- regions_intensity$shortname[which.max(regions_intensity$forecast)]

# Print results
print(paste("Current time:", now()))
print(paste("Lowest intensity region:", min_region))
print(paste("Highest intensity region:", max_region))
```

### Carbon intensity between 2 dates

The following function calculates the average carbon intensity between two dates. 

Note that the API limits the date range to a maximum of 30 days.

```{r}
avg_co2_intensity <- function(date1, date2){
  
  # Create URL
  url <- sprintf('https://api.carbonintensity.org.uk/intensity/%s/%s', date1, date2)

  # Make request, parse, retrieve data
  r <- GET(url)
  parsed <- fromJSON(content(r, 'text'))
  data <- parsed$data %>% unnest(intensity)
  
  # Calculate avg CO2
  avg_co2_per_kwh <- mean(data$actual)
  
  return(avg_co2_per_kwh)
}

# Testing the function
date1 <- '2017-10-01'
date2 <- '2017-10-10'
avg_co2_intensity(date1, date2)

```
